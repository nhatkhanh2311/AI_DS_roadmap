# Giai ƒëo·∫°n 3: Thu th·∫≠p v√† Qu·∫£n l√Ω D·ªØ li·ªáu
## B√†i 3.3: SQL (Ph·∫ßn 3) - N√¢ng cao cho Ph√¢n t√≠ch

### **üéØ M·ª•c ti√™u b√†i h·ªçc:**
1.  Hi·ªÉu v√† s·ª≠ d·ª•ng **Common Table Expressions (CTEs)** ƒë·ªÉ t·ªï ch·ª©c c√°c truy v·∫•n ph·ª©c t·∫°p.
2.  N·∫Øm v·ªØng kh√°i ni·ªám v√† c√∫ ph√°p c·ªßa **Window Functions** ƒë·ªÉ th·ª±c hi·ªán c√°c ph√©p t√≠nh tr√™n m·ªôt "c·ª≠a s·ªï" d·ªØ li·ªáu.
3.  √Åp d·ª•ng Window Functions v√†o c√°c b√†i to√°n ph√¢n t√≠ch th·ª±c t·∫ø nh∆∞ x·∫øp h·∫°ng v√† so s√°nh.

---

### **1. Common Table Expressions (CTEs) - "B·∫£ng T·∫°m"**

Khi c√°c truy v·∫•n c·ªßa b·∫°n tr·ªü n√™n ph·ª©c t·∫°p v·ªõi nhi·ªÅu truy v·∫•n con (subqueries) l·ªìng nhau, ch√∫ng s·∫Ω r·∫•t kh√≥ ƒë·ªçc v√† b·∫£o tr√¨. **CTEs** cho ph√©p b·∫°n ƒë·∫∑t t√™n cho m·ªôt k·∫øt qu·∫£ t·∫°m th·ªùi v√† s·ª≠ d·ª•ng n√≥ trong c√¢u l·ªánh ch√≠nh, gi·ªëng nh∆∞ m·ªôt c√°i "b·∫£ng t·∫°m".

* **C√∫ ph√°p:** `WITH ten_bang_tam AS (...) SELECT ... FROM ten_bang_tam;`


    -- V√≠ d·ª•: T√¨m c√°c nh√¢n vi√™n c√≥ l∆∞∆°ng cao h∆°n l∆∞∆°ng trung b√¨nh c·ªßa ph√≤ng ban c·ªßa h·ªç.
    
    -- C√°ch d√πng Subquery (kh√≥ ƒë·ªçc)
    SELECT Name, Salary, Department
    FROM Employees
    WHERE Salary > (SELECT AVG(Salary) FROM Employees WHERE Department = Employees.Department);

    -- C√°ch d√πng CTE (d·ªÖ ƒë·ªçc h∆°n nhi·ªÅu)
    WITH DepartmentAvgSalary AS (
        SELECT Department, AVG(Salary) as AvgSal
        FROM Employees
        GROUP BY Department
    )
    SELECT
        E.Name,
        E.Salary,
        E.Department,
        DAS.AvgSal
    FROM
        Employees AS E
    JOIN
        DepartmentAvgSalary AS DAS ON E.Department = DAS.Department
    WHERE
        E.Salary > DAS.AvgSal;

---

### **2. Window Functions - Ph√©p t√≠nh tr√™n m·ªôt "C·ª≠a s·ªï" D·ªØ li·ªáu ü™ü**

ƒê√¢y l√† m·ªôt trong nh·ªØng t√≠nh nƒÉng m·∫°nh m·∫Ω nh·∫•t c·ªßa SQL cho vi·ªác ph√¢n t√≠ch.

H√£y nh·ªõ l·∫°i: `GROUP BY` g·ªôp nhi·ªÅu h√†ng th√†nh m·ªôt h√†ng duy nh·∫•t.
**Window Functions** th√¨ kh√°c: n√≥ th·ª±c hi·ªán m·ªôt ph√©p t√≠nh tr√™n m·ªôt t·∫≠p c√°c h√†ng (m·ªôt "c·ª≠a s·ªï") nh∆∞ng v·∫´n **gi·ªØ nguy√™n s·ªë l∆∞·ª£ng h√†ng** ban ƒë·∫ßu.

* **C√∫ ph√°p chung:** `HAM_CUA_SO() OVER (PARTITION BY ... ORDER BY ...)`
    * **`HAM_CUA_SO()`**: C√≥ th·ªÉ l√† h√†m t·ªïng h·ª£p (`SUM`, `AVG`, `COUNT`) ho·∫∑c c√°c h√†m chuy√™n bi·ªát (`RANK`, `ROW_NUMBER`, `LAG`, `LEAD`).
    * **`OVER (...)`**: T·ª´ kh√≥a b√°o hi·ªáu ƒë√¢y l√† m·ªôt Window Function.
    * **`PARTITION BY ten_cot`**: Chia d·ªØ li·ªáu th√†nh c√°c "c·ª≠a s·ªï" (ph√¢n v√πng) d·ª±a tr√™n gi√° tr·ªã c·ªßa `ten_cot`. N√≥ gi·ªëng nh∆∞ `GROUP BY` nh∆∞ng kh√¥ng g·ªôp h√†ng.
    * **`ORDER BY ten_cot`**: S·∫Øp x·∫øp c√°c h√†ng b√™n trong m·ªói c·ª≠a s·ªï.

#### **a. X·∫øp h·∫°ng (Ranking)**

* **`RANK()`**: X·∫øp h·∫°ng c√°c h√†ng. N·∫øu c√≥ c√°c gi√° tr·ªã b·∫±ng nhau, ch√∫ng s·∫Ω c√≥ c√πng m·ªôt h·∫°ng v√† h·∫°ng ti·∫øp theo s·∫Ω b·ªã b·ªè qua (1, 2, 2, 4).
* **`DENSE_RANK()`**: T∆∞∆°ng t·ª± `RANK` nh∆∞ng kh√¥ng b·ªè qua h·∫°ng (1, 2, 2, 3).
* **`ROW_NUMBER()`**: ƒê√°nh s·ªë th·ª© t·ª± c√°c h√†ng m·ªôt c√°ch duy nh·∫•t (1, 2, 3, 4).


    -- X·∫øp h·∫°ng l∆∞∆°ng c·ªßa nh√¢n vi√™n trong m·ªói ph√≤ng ban
    SELECT
        Name,
        Department,
        Salary,
        RANK() OVER (PARTITION BY Department ORDER BY Salary DESC) as DeptRank
    FROM
        Employees;

#### **b. T√≠nh to√°n L≈©y k·∫ø (Running Totals)**

    -- T√≠nh t·ªïng l∆∞∆°ng l≈©y k·∫ø trong m·ªói ph√≤ng ban (s·∫Øp x·∫øp theo ng√†y tuy·ªÉn d·ª•ng)
    SELECT
        Name,
        Department,
        HireDate,
        Salary,
        SUM(Salary) OVER (PARTITION BY Department ORDER BY HireDate) as RunningTotalSalary
    FROM
        Employees;

---

### **‚úçÔ∏è B√†i th·ª±c h√†nh:**

Ti·∫øp t·ª•c s·ª≠ d·ª•ng DataGrip v√† 2 b·∫£ng `Employees`, `Departments`.

1.  **X·∫øp h·∫°ng Nh√¢n vi√™n:**
    * Vi·∫øt m·ªôt truy v·∫•n ƒë·ªÉ x·∫øp h·∫°ng **to√†n b·ªô** nh√¢n vi√™n (kh√¥ng `PARTITION BY`) d·ª±a tr√™n m·ª©c l∆∞∆°ng c·ªßa h·ªç t·ª´ cao ƒë·∫øn th·∫•p.
    * S·ª≠ d·ª•ng c·∫£ 3 h√†m `RANK()`, `DENSE_RANK()`, v√† `ROW_NUMBER()` ƒë·ªÉ xem s·ª± kh√°c bi·ªát. ƒê·∫∑t t√™n cho c√°c c·ªôt k·∫øt qu·∫£ l√† `Rank`, `DenseRank`, `RowNumber`.

2.  **So s√°nh L∆∞∆°ng v·ªõi Qu·∫£n l√Ω:**
    * S·ª≠ d·ª•ng **CTE** v√† **JOIN**, vi·∫øt m·ªôt truy v·∫•n ƒë·ªÉ t√¨m ra nh·ªØng nh√¢n vi√™n c√≥ m·ª©c l∆∞∆°ng **cao h∆°n** ng∆∞·ªùi qu·∫£n l√Ω c·ªßa ph√≤ng ban h·ªç.
    * **G·ª£i √Ω:**
        * B∆∞·ªõc 1 (trong CTE): `JOIN` b·∫£ng `Employees` v√† `Departments` ƒë·ªÉ l·∫•y th√¥ng tin `Name`, `Salary`, `Manager`.
        * B∆∞·ªõc 2: T·ª± `JOIN` (self-join) CTE ƒë√≥ ƒë·ªÉ so s√°nh l∆∞∆°ng c·ªßa nh√¢n vi√™n v·ªõi l∆∞∆°ng c·ªßa ng∆∞·ªùi c√≥ t√™n l√† qu·∫£n l√Ω c·ªßa h·ªç. (ƒê√¢y l√† m·ªôt b√†i t·∫≠p n√¢ng cao).

3.  **T√¨m Nh√¢n vi√™n ƒë∆∞·ª£c tuy·ªÉn d·ª•ng ngay tr∆∞·ªõc ƒë√≥:**
    * Vi·∫øt m·ªôt truy v·∫•n s·ª≠ d·ª•ng Window Function `LAG()` ƒë·ªÉ hi·ªÉn th·ªã t√™n c·ªßa m·ªói nh√¢n vi√™n, ng√†y tuy·ªÉn d·ª•ng c·ªßa h·ªç, v√† **t√™n c·ªßa nh√¢n vi√™n ƒë∆∞·ª£c tuy·ªÉn d·ª•ng ngay tr∆∞·ªõc h·ªç** trong c√πng m·ªôt ph√≤ng ban.
    * **C√∫ ph√°p g·ª£i √Ω:** `LAG(Name, 1) OVER (PARTITION BY Department ORDER BY HireDate)`