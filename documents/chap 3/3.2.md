# Giai ƒëo·∫°n 3: Thu th·∫≠p v√† Qu·∫£n l√Ω D·ªØ li·ªáu
## B√†i 3.2: SQL (Ph·∫ßn 2) - T·ªïng h·ª£p & K·∫øt n·ªëi D·ªØ li·ªáu

### **üéØ M·ª•c ti√™u b√†i h·ªçc:**
1.  S·ª≠ d·ª•ng c√°c **h√†m t·ªïng h·ª£p (aggregate functions)** ƒë·ªÉ t√≠nh to√°n c√°c gi√° tr·ªã th·ªëng k√™.
2.  N·∫Øm v·ªØng m·ªánh ƒë·ªÅ **`GROUP BY`** ƒë·ªÉ nh√≥m c√°c h√†ng d·ªØ li·ªáu.
3.  Hi·ªÉu v√† s·ª≠ d·ª•ng **`JOIN`** ƒë·ªÉ k·∫øt h·ª£p d·ªØ li·ªáu t·ª´ hai ho·∫∑c nhi·ªÅu b·∫£ng.

---

### **1. C√°c h√†m t·ªïng h·ª£p (Aggregate Functions)**

C√°c h√†m n√†y th·ª±c hi·ªán m·ªôt ph√©p t√≠nh tr√™n m·ªôt t·∫≠p h·ª£p c√°c h√†ng v√† tr·∫£ v·ªÅ m·ªôt gi√° tr·ªã duy nh·∫•t.

* **`COUNT()`**: ƒê·∫øm s·ªë l∆∞·ª£ng h√†ng. `COUNT(*)` ƒë·∫øm t·∫•t c·∫£ c√°c h√†ng, `COUNT(ten_cot)` ƒë·∫øm c√°c h√†ng c√≥ gi√° tr·ªã kh√¥ng null ·ªü c·ªôt ƒë√≥.
* **`SUM()`**: T√≠nh t·ªïng c√°c gi√° tr·ªã.
* **`AVG()`**: T√≠nh trung b√¨nh.
* **`MIN()`**: T√¨m gi√° tr·ªã nh·ªè nh·∫•t.
* **`MAX()`**: T√¨m gi√° tr·ªã l·ªõn nh·∫•t.

    -- V√≠ d·ª•: T√≠nh t·ªïng l∆∞∆°ng, l∆∞∆°ng trung b√¨nh, v√† s·ªë l∆∞·ª£ng nh√¢n vi√™n
    SELECT
        SUM(Salary) AS TotalSalary,
        AVG(Salary) AS AverageSalary,
        COUNT(ID) AS NumberOfEmployees
    FROM
        Employees;

* **`AS`**: L√† m·ªôt t·ª´ kh√≥a ƒë·ªÉ ƒë·∫∑t t√™n m·ªõi (b√≠ danh - alias) cho c·ªôt k·∫øt qu·∫£ ƒë·ªÉ d·ªÖ ƒë·ªçc h∆°n.

---

### **2. Nh√≥m d·ªØ li·ªáu v·ªõi `GROUP BY`**

M·ªánh ƒë·ªÅ `GROUP BY` l√† m·ªôt trong nh·ªØng c√¥ng c·ª• m·∫°nh m·∫Ω nh·∫•t cho vi·ªác ph√¢n t√≠ch. N√≥ nh√≥m c√°c h√†ng c√≥ c√πng gi√° tr·ªã trong m·ªôt ho·∫∑c nhi·ªÅu c·ªôt l·∫°i th√†nh c√°c nh√≥m t√≥m t·∫Øt. N√≥ th∆∞·ªùng ƒë∆∞·ª£c s·ª≠ d·ª•ng c√πng v·ªõi c√°c h√†m t·ªïng h·ª£p.

    -- ƒê·∫øm s·ªë l∆∞·ª£ng nh√¢n vi√™n trong m·ªói ph√≤ng ban
    SELECT
        Department,
        COUNT(ID) AS NumberOfEmployees
    FROM
        Employees
    GROUP BY
        Department;

    -- T√≠nh l∆∞∆°ng trung b√¨nh cho m·ªói ph√≤ng ban, ch·ªâ l·∫•y nh·ªØng ph√≤ng c√≥ l∆∞∆°ng trung b√¨nh > 70000
    SELECT
        Department,
        AVG(Salary) AS AvgSalary
    FROM
        Employees
    GROUP BY
        Department
    HAVING -- M·ªánh ƒë·ªÅ HAVING d√πng ƒë·ªÉ l·ªçc c√°c nh√≥m sau khi ƒë√£ GROUP BY
        AVG(Salary) > 70000;

**L∆∞u √Ω:** `WHERE` l·ªçc c√°c h√†ng **tr∆∞·ªõc khi** nh√≥m, `HAVING` l·ªçc c√°c nh√≥m **sau khi** ƒë√£ nh√≥m.

---

### **3. K·∫øt n·ªëi B·∫£ng v·ªõi `JOIN`**

Trong th·ª±c t·∫ø, d·ªØ li·ªáu th∆∞·ªùng ƒë∆∞·ª£c l∆∞u tr·ªØ trong nhi·ªÅu b·∫£ng kh√°c nhau. `JOIN` l√† m·ªánh ƒë·ªÅ cho ph√©p b·∫°n k·∫øt h·ª£p c√°c h√†ng t·ª´ hai ho·∫∑c nhi·ªÅu b·∫£ng d·ª±a tr√™n m·ªôt c·ªôt li√™n quan.

H√£y t∆∞·ªüng t∆∞·ª£ng ch√∫ng ta c√≥ th√™m m·ªôt b·∫£ng `Departments`:

| DeptName | Manager |
| :--- | :--- |
| Sales | 'Alice' |
| Marketing| 'Bob' |
| IT | 'Charlie' |
| HR | 'David' |

* **`INNER JOIN`**: Tr·∫£ v·ªÅ c√°c h√†ng khi c√≥ s·ª± tr√πng kh·ªõp ·ªü c·∫£ hai b·∫£ng. ƒê√¢y l√† lo·∫°i JOIN ph·ªï bi·∫øn nh·∫•t.

    -- L·∫•y t√™n nh√¢n vi√™n v√† t√™n ng∆∞·ªùi qu·∫£n l√Ω c·ªßa h·ªç
    SELECT
        E.Name,
        E.Department,
        D.Manager
    FROM
        Employees AS E
    INNER JOIN
        Departments AS D ON E.Department = D.DeptName;

* **`LEFT JOIN`**: Tr·∫£ v·ªÅ **t·∫•t c·∫£** c√°c h√†ng t·ª´ b·∫£ng b√™n tr√°i (`Employees`), v√† c√°c h√†ng tr√πng kh·ªõp t·ª´ b·∫£ng b√™n ph·∫£i (`Departments`). N·∫øu kh√¥ng c√≥ s·ª± tr√πng kh·ªõp, c√°c c·ªôt c·ªßa b·∫£ng b√™n ph·∫£i s·∫Ω c√≥ gi√° tr·ªã `NULL`.

---

### **‚úçÔ∏è B√†i th·ª±c h√†nh:**

H√£y ti·∫øp t·ª•c s·ª≠ d·ª•ng DataGrip v√† CSDL `postgres` c·ªßa b·∫°n.

1.  **B∆∞·ªõc 1: T·∫°o b·∫£ng `Departments`:**
    Ch·∫°y ƒëo·∫°n code sau trong console ƒë·ªÉ t·∫°o v√† th√™m d·ªØ li·ªáu cho b·∫£ng m·ªõi.

        CREATE TABLE Departments (
            DeptName VARCHAR(50) PRIMARY KEY,
            Manager VARCHAR(100)
        );
        INSERT INTO Departments (DeptName, Manager) VALUES
        ('Sales', 'Alice'),
        ('Marketing', 'Bob'),
        ('IT', 'Charlie'),
        ('HR', 'David');

2.  **B∆∞·ªõc 2: Gi·∫£i c√°c b√†i t·∫≠p sau:**
    * **C√¢u 1 (`GROUP BY`):** Vi·∫øt m·ªôt truy v·∫•n ƒë·ªÉ t√¨m ra m·ª©c l∆∞∆°ng **cao nh·∫•t** (`MAX`) trong m·ªói ph√≤ng ban (`Department`).
    * **C√¢u 2 (`GROUP BY` & `HAVING`):** Vi·∫øt m·ªôt truy v·∫•n ƒë·ªÉ ƒë·∫øm s·ªë l∆∞·ª£ng nh√¢n vi√™n trong m·ªói ph√≤ng ban, nh∆∞ng ch·ªâ hi·ªÉn th·ªã nh·ªØng ph√≤ng ban c√≥ **nhi·ªÅu h∆°n 1** nh√¢n vi√™n.
    * **C√¢u 3 (`INNER JOIN`):** Vi·∫øt m·ªôt truy v·∫•n ƒë·ªÉ hi·ªÉn th·ªã **t√™n nh√¢n vi√™n (`Name`)** v√† **t√™n ng∆∞·ªùi qu·∫£n l√Ω (`Manager`)** c·ªßa h·ªç.
    * **C√¢u 4 (Th·ª≠ th√°ch - `LEFT JOIN`):** Gi·∫£ s·ª≠ ch√∫ng ta th√™m m·ªôt nh√¢n vi√™n m·ªõi v√†o ph√≤ng "Finance" (m·ªôt ph√≤ng ch∆∞a c√≥ trong b·∫£ng `Departments`).
        
            INSERT INTO Employees (ID, Name, Department, Salary, HireDate) VALUES
            (8, 'Eva Green', 'Finance', 88000, '2023-05-01');
        
        B√¢y gi·ªù, h√£y vi·∫øt m·ªôt truy v·∫•n `LEFT JOIN` t·ª´ b·∫£ng `Employees` sang b·∫£ng `Departments`. Quan s√°t v√† gi·∫£i th√≠ch t·∫°i sao nh√¢n vi√™n 'Eva Green' v·∫´n xu·∫•t hi·ªán trong k·∫øt qu·∫£ trong khi `INNER JOIN` s·∫Ω kh√¥ng hi·ªÉn th·ªã c√¥ ·∫•y.