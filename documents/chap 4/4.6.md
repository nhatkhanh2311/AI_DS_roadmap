# Giai đoạn 4: Nhập môn Học Máy và các Nguyên lý Cốt lõi
## Bài 4.6: Huấn luyện & Đánh giá Mô hình Hồi quy

### **🎯 Mục tiêu bài học:**
1.  Hiểu sự khác biệt giữa việc đánh giá mô hình phân loại và mô hình hồi quy.
2.  Nắm vững các chỉ số đánh giá cốt lõi cho bài toán hồi quy: **MAE, MSE, RMSE, và R-squared ($R^2$)**.
3.  Biết cách diễn giải và lựa chọn chỉ số phù hợp cho từng tình huống.

---

### **Bối cảnh & Tầm quan trọng**

Trong bài toán phân loại, câu trả lời thường là "đúng" hoặc "sai". Nhưng với hồi quy, câu trả lời là một con số, và chúng ta cần biết: "dự đoán của tôi **sai lệch bao nhiêu** so với thực tế?".

Ví dụ, khi dự đoán giá nhà:
* Mô hình A dự đoán sai 100 triệu.
* Mô hình B dự đoán sai 500 triệu.

Rõ ràng mô hình A tốt hơn, nhưng chúng ta cần những chỉ số được chuẩn hóa để đo lường và so sánh hiệu năng một cách khách quan. Việc lựa chọn chỉ số nào để tối ưu cũng rất quan trọng, vì mỗi chỉ số sẽ "trừng phạt" các loại lỗi khác nhau.

---

### **Lý thuyết Cốt lõi & Nền tảng Toán học**

Giả sử:
* $y_i$: là giá trị thực tế của điểm dữ liệu thứ $i$.
* $\hat{y}_i$ (y-hat): là giá trị dự đoán của mô hình cho điểm dữ liệu thứ $i$.
* $m$: là tổng số điểm dữ liệu.

#### **1. Mean Absolute Error (MAE) - Sai số Tuyệt đối Trung bình**
* **Công thức:**
    $$ \text{MAE} = \frac{1}{m} \sum_{i=1}^{m} |y_i - \hat{y}_i| $$
* **Diễn giải:** Là giá trị **trung bình của khoảng cách tuyệt đối** giữa giá trị dự đoán và giá trị thực tế.
* **Đặc tính:** Rất dễ hiểu vì nó có cùng đơn vị với giá trị cần dự đoán. Ví dụ, MAE là 150 triệu có nghĩa là, trung bình, mô hình dự đoán sai lệch 150 triệu. Nó không "trừng phạt" các lỗi lớn một cách đặc biệt.

#### **2. Mean Squared Error (MSE) - Sai số Bình phương Trung bình**
* **Công thức:**
    $$ \text{MSE} = \frac{1}{m} \sum_{i=1}^{m} (y_i - \hat{y}_i)^2 $$
* **Diễn giải:** Là giá trị **trung bình của bình phương sai số**.
* **Đặc tính:** Vì các sai số được bình phương lên, MSE **"trừng phạt" các lỗi lớn nặng hơn rất nhiều** so với các lỗi nhỏ. Một lần dự đoán sai 1 tỷ sẽ ảnh hưởng đến MSE nhiều hơn rất nhiều so với 10 lần dự đoán sai 100 triệu. Nhược điểm của nó là đơn vị bị bình phương lên (ví dụ: `(triệu đồng)^2`), nên khó diễn giải.

#### **3. Root Mean Squared Error (RMSE) - Căn Bậc hai của Sai số Bình phương Trung bình**
* **Công thức:**
    $$ \text{RMSE} = \sqrt{\text{MSE}} = \sqrt{\frac{1}{m} \sum_{i=1}^{m} (y_i - \hat{y}_i)^2} $$
* **Diễn giải:** Đơn giản là căn bậc hai của MSE.
* **Đặc tính:** Nó vừa **trừng phạt các lỗi lớn** (do có bình phương bên trong), vừa có **cùng đơn vị** với giá trị dự đoán, làm cho nó trở thành một trong những chỉ số phổ biến nhất để báo cáo hiệu năng của mô hình hồi quy.

#### **4. R-squared ($R^2$) - Hệ số Xác định**
* **Ý tưởng:** Thay vì đo sai số tuyệt đối, $R^2$ đo lường **mô hình của bạn tốt hơn bao nhiêu so với một mô hình ngây thơ** chỉ luôn dự đoán giá trị trung bình.
* **Công thức:**
    $$ R^2 = 1 - \frac{\sum (y_i - \hat{y}_i)^2}{\sum (y_i - \bar{y})^2} = 1 - \frac{\text{MSE}}{\text{Phương sai của y}} $$
    * $\bar{y}$ (y-bar) là giá trị trung bình của tất cả các giá trị thực tế $y_i$.
* **Diễn giải:** $R^2$ là một giá trị từ $(-\infty, 1]$. Nó cho biết **bao nhiêu phần trăm sự biến thiên của dữ liệu được mô hình giải thích**.
    * $R^2 = 1$: Mô hình hoàn hảo, giải thích được 100% sự biến thiên.
    * $R^2 = 0$: Mô hình không tốt hơn việc chỉ đoán bừa bằng giá trị trung bình.
    * $R^2 = 0.75$: Mô hình giải thích được 75% sự biến thiên của dữ liệu.
    * $R^2 < 0$: Mô hình còn tệ hơn cả việc đoán bừa.

---

### **Triển khai & Phân tích Code**

Chúng ta sẽ sử dụng bộ dữ liệu kinh điển `Boston Housing` để dự đoán giá nhà.

    import pandas as pd
    from sklearn.model_selection import train_test_split
    from sklearn.linear_model import LinearRegression
    from sklearn.metrics import mean_absolute_error, mean_squared_error, r2_score
    import numpy as np

    # Tải bộ dữ liệu Boston housing
    # Lưu ý: Bộ dữ liệu này được tích hợp sẵn trong các phiên bản scikit-learn cũ.
    # Với các phiên bản mới, ta nên tải từ nguồn khác.
    # Đoạn code sau dùng link từ github của scikit-learn để đảm bảo tính ổn định.
    data_url = "http://lib.stat.cmu.edu/datasets/boston"
    raw_df = pd.read_csv(data_url, sep="\s+", skiprows=22, header=None)
    data = np.hstack([raw_df.values[::2, :], raw_df.values[1::2, :2]])
    target = raw_df.values[1::2, 2]
    # Chuyển thành DataFrame
    X = pd.DataFrame(data)
    y = pd.Series(target)
    
    # Chia dữ liệu
    X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)
    
    # Huấn luyện mô hình Hồi quy Tuyến tính
    model = LinearRegression()
    model.fit(X_train, y_train)
    
    # Đưa ra dự đoán
    y_pred = model.predict(X_test)
    
    # Tính toán các chỉ số
    mae = mean_absolute_error(y_test, y_pred)
    mse = mean_squared_error(y_test, y_pred)
    rmse = np.sqrt(mse)
    r2 = r2_score(y_test, y_pred)

    print("--- Kết quả Đánh giá Mô hình Hồi quy ---")
    print(f"Mean Absolute Error (MAE): {mae:.4f}")
    print(f"Mean Squared Error (MSE): {mse:.4f}")
    print(f"Root Mean Squared Error (RMSE): {rmse:.4f}")
    print(f"R-squared (R2): {r2:.4f}")

---

### **✍️ Bài thực hành:**

Sử dụng cùng bộ dữ liệu `Boston Housing` đã được chia ở trên (`X_train`, `X_test`, `y_train`, `y_test`).

1.  **Huấn luyện một mô hình khác:**
    * Import `RandomForestRegressor` từ `sklearn.ensemble`.
    * Khởi tạo và huấn luyện một mô hình Random Forest trên cùng bộ dữ liệu huấn luyện.
    * Đưa ra dự đoán trên tập test.

2.  **Đánh giá và So sánh:**
    * Tính toán tất cả 4 chỉ số (MAE, MSE, RMSE, $R^2$) cho mô hình `RandomForestRegressor`.
    * Dựa trên các chỉ số đó, so sánh hiệu năng của `RandomForestRegressor` với `LinearRegression`. Mô hình nào hoạt động tốt hơn? Tại sao? (Gợi ý: MAE/MSE/RMSE càng thấp càng tốt, $R^2$ càng cao càng tốt).