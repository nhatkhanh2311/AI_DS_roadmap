# Giai đoạn 4: Nhập môn Học Máy và các Nguyên lý Cốt lõi
## Bài 4.2: Tiền xử lý Dữ liệu Cơ bản (Train-Test Split, Xử lý Giá trị thiếu)

### **🎯 Mục tiêu bài học:**
1.  Hiểu tại sao việc **chia dữ liệu (Train-Test Split)** là bước bắt buộc để đánh giá mô hình một cách khách quan.
2.  Nắm vững các chiến lược xử lý **giá trị thiếu (missing values)** và phân tích ưu/nhược điểm của chúng.
3.  Thực hành các kỹ thuật này bằng thư viện Scikit-learn và Pandas.

---

### **Bối cảnh & Tầm quan trọng**

Trong thế giới thực, dữ liệu không bao giờ hoàn hảo. Nó thường bị thiếu thông tin, không nhất quán và lộn xộn. Việc đưa dữ liệu thô trực tiếp vào một thuật toán học máy cũng giống như đưa bùn đất vào một động cơ F1—nó sẽ không hoạt động, thậm chí có thể gây ra kết quả sai lệch nghiêm trọng.

Bài học này tuân thủ nguyên tắc vàng: **"Rác đầu vào, Rác đầu ra" (Garbage In, Garbage Out)**. Chất lượng của mô hình dự đoán của bạn phụ thuộc trực tiếp vào chất lượng của dữ liệu bạn dùng để huấn luyện nó. Việc tiền xử lý dữ liệu một cách cẩn thận là một trong những công việc tốn nhiều thời gian nhất nhưng cũng mang lại hiệu quả cao nhất trong một dự án khoa học dữ liệu.

---

### **Lý thuyết Cốt lõi**

#### **1. Phân chia Dữ liệu (Train-Test Split)**

**Vấn đề:** Làm thế nào để bạn biết mô hình của mình hoạt động tốt? Nếu bạn huấn luyện và kiểm tra mô hình trên cùng một bộ dữ liệu, nó sẽ giống như việc cho một học sinh làm bài kiểm tra mà đã biết trước đề và đáp án. Học sinh đó có thể đạt điểm 100, nhưng điều đó không có nghĩa là họ thực sự hiểu bài. Mô hình cũng vậy, nó có thể "học vẹt" (overfit) dữ liệu huấn luyện và sẽ hoạt động rất tệ khi gặp dữ liệu mới trong thực tế.

**Giải pháp:** Chúng ta phải mô phỏng lại tình huống thực tế bằng cách chia dữ liệu của mình thành hai phần:
* **Tập Huấn luyện (Training Set):** (Thường là 70-80% dữ liệu) Dùng để "dạy" cho mô hình. Mô hình sẽ xem cả đặc trưng (X) và nhãn (y) của tập này để học ra các quy luật.
* **Tập Kiểm tra (Testing Set):** (Thường là 20-30% dữ liệu) Dùng để **đánh giá** hiệu năng của mô hình sau khi đã huấn luyện xong. Tập này được coi như "dữ liệu mới" mà mô hình chưa từng thấy. Chúng ta sẽ đưa đặc trưng (X) của tập này cho mô hình dự đoán và so sánh kết quả với nhãn (y) thực tế.

**Quy tắc vàng:** **Tập kiểm tra phải được giữ bí mật tuyệt đối** cho đến bước đánh giá cuối cùng. Mọi quyết định về tiền xử lý hay lựa chọn mô hình đều phải dựa trên tập huấn luyện.

#### **2. Xử lý Giá trị thiếu (Missing Values)**

**Vấn đề:** Hầu hết các thuật toán học máy đều dựa trên các phép toán ma trận và không thể xử lý các giá trị bị thiếu (thường được biểu diễn là `NaN` - Not a Number).

**Các chiến lược xử lý:**

##### **a. Xóa bỏ (Deletion)**
* **Xóa hàng (Row Deletion):** Xóa toàn bộ hàng có chứa giá trị thiếu.
    * **Ưu điểm:** Đơn giản.
    * **Nhược điểm:** Có thể làm mất rất nhiều dữ liệu quý giá nếu có nhiều hàng bị thiếu dù chỉ một cột.
* **Xóa cột (Column Deletion):** Xóa toàn bộ cột nếu nó có quá nhiều giá trị thiếu.
    * **Ưu điểm:** Đơn giản.
    * **Nhược điểm:** Có thể làm mất đi một đặc trưng quan trọng.

##### **b. Điền giá trị (Imputation)**
Đây là phương pháp phổ biến hơn: thay thế các giá trị `NaN` bằng một giá trị ước tính.
* **Điền bằng Trung bình (Mean Imputation):** Thay thế bằng giá trị trung bình của cột.
    * **Ưu điểm:** Đơn giản.
    * **Nhược điểm:** Chỉ dùng cho cột số, rất nhạy cảm với giá trị ngoại lai (outliers).
* **Điền bằng Trung vị (Median Imputation):** Thay thế bằng giá trị trung vị của cột.
    * **Ưu điểm:** Đơn giản, **không bị ảnh hưởng bởi outliers**. Lựa chọn tốt hơn cho các cột số bị lệch.
* **Điền bằng Yếu vị (Mode Imputation):** Thay thế bằng giá trị xuất hiện thường xuyên nhất.
    * **Ưu điểm:** Có thể dùng cho cả cột số và **cột hạng mục (categorical)**.

---

### **Triển khai với Code**

    import pandas as pd
    from sklearn.model_selection import train_test_split

    df = pd.read_csv('titanic.csv')

    # --- 1. Train-Test Split ---
    # Đầu tiên, tách đặc trưng (X) và nhãn mục tiêu (y)
    X = df.drop('Survived', axis=1) # Bỏ cột 'Survived' để có X
    y = df['Survived']             # Lấy cột 'Survived' làm y

    # Thực hiện chia dữ liệu
    # test_size=0.2: dành 20% cho tập test
    # random_state=42: đảm bảo kết quả chia luôn giống nhau mỗi lần chạy
    X_train, X_test, y_train, y_test = train_test_split(
        X, y, test_size=0.2, random_state=42
    )

    print("--- Kích thước sau khi chia ---")
    print(f"Kích thước X_train: {X_train.shape}")
    print(f"Kích thước X_test: {X_test.shape}")


    # --- 2. Xử lý Giá trị thiếu ---
    print("\n--- Giá trị thiếu TRƯỚC khi xử lý (trên tập train) ---")
    print(X_train.isnull().sum())

    # Chiến lược: Điền giá trị thiếu cho cột 'Age' bằng TRUNG VỊ
    # Ta tính trung vị trên tập train ĐỂ TRÁNH RÒ RỈ DỮ LIỆU
    median_age = X_train['Age'].median()
    print(f"\nTuổi trung vị trên tập train: {median_age:.2f}")

    # Áp dụng điền giá trị cho cả tập train và tập test
    # inplace=True để thay đổi trực tiếp trên DataFrame
    X_train['Age'].fillna(median_age, inplace=True)
    X_test['Age'].fillna(median_age, inplace=True) 

    print("\n--- Giá trị thiếu SAU khi xử lý (trên tập train) ---")
    print(X_train.isnull().sum())

---

### **Thảo luận Nâng cao & Các "Cạm bẫy"**

* **Rò rỉ Dữ liệu (Data Leakage):** Một trong những sai lầm nghiêm trọng nhất. **Bạn phải luôn thực hiện Train-Test Split TRƯỚC khi làm bất cứ việc gì khác.** Ví dụ, nếu bạn tính tuổi trung bình trên toàn bộ bộ dữ liệu rồi mới chia, thì thông tin từ tập test (tuổi của hành khách trong tập test) đã bị "rò rỉ" vào quá trình tiền xử lý của tập train. Điều này làm cho kết quả đánh giá của bạn trở nên lạc quan một cách giả tạo.

---

### **✍️ Bài thực hành:**

Sử dụng các tập `X_train`, `X_test` đã được xử lý ở trên.

1.  **Phân tích Cột `Embarked`:**
    * Cột `Embarked` (Cảng lên tàu) có một vài giá trị bị thiếu.
    * Hãy kiểm tra xem giá trị nào là **mode** (giá trị xuất hiện nhiều nhất) của cột `Embarked` trong tập **`X_train`**.
    * Viết code để điền các giá trị thiếu trong cả `X_train` và `X_test` bằng giá trị mode bạn vừa tìm được.

2.  **Phân tích Cột `Cabin`:**
    * Nhận xét về số lượng giá trị thiếu trong cột `Cabin`.
    * Với một cột có tỷ lệ thiếu cao như vậy, chiến lược **xóa cột** có phải là một lựa chọn hợp lý không? Tại sao? Viết code để xóa cột `Cabin` khỏi cả `X_train` và `X_test`. **Gợi ý:** dùng `df.drop('ten_cot', axis=1, inplace=True)`.